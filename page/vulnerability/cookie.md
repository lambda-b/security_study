---
title: CookieのSecure/httpOnly属性問題
next: false
---

# CookieのSecure/httpOnly属性問題

## 1. 概要・原因

Cookieの属性に `Secure` や `HttpOnly` を適切に設定しないことで、以下のような攻撃リスクが発生します：

- `Secure` 属性がない場合：HTTPS通信であっても、HTTP経由で送信される可能性があり、セッションIDが盗聴される危険がある
- `HttpOnly` 属性がない場合：JavaScriptから `document.cookie` を介してCookieにアクセス可能となり、XSS攻撃と組み合わさってCookieが窃取されるリスクがある

原因：

- 開発者がセキュリティ属性の意義を知らない
- テストやローカル開発時に属性を省略してしまい、そのまま本番反映されてしまう
- 特定のブラウザやAPIとの互換性懸念からあえて付けないケース

## 2. 実際の事件や悪用例

- 2000年代初期：セッションIDがURLやCookieから漏洩し、盗聴・なりすまし攻撃が相次いだ
- XSSと組み合わせて `document.cookie` からセッションIDを窃取する攻撃が実証されている

## 3. OWASP ASVS 5.0 における該当要件

| レベル   | 要件番号   | 内容                                            |
|----------|------------|-------------------------------------------------|
| L1〜L3   | V3.4.2      | セッションCookieには Secure 属性を付けること        |
| L1〜L3   | V3.4.3      | セッションCookieには HttpOnly 属性を付けること     |

## 4. 一般的な対策

- セッションCookieには必ず `Secure` と `HttpOnly` 属性を付与
- HTTPS通信を強制（HSTSと併用推奨）
- Cookieの `SameSite` 属性も併せて設定する（CSRF対策）

## 5. フレームワーク別の注意点

### Spring Security

- `HttpSession` 管理時、自動的に `HttpOnly` と `Secure` が付与される（`secure` はHTTPS使用時）
- 明示的に `CookieSerializer` を設定することで、属性制御が可能

```java
@Bean
public CookieSerializer cookieSerializer() {
    DefaultCookieSerializer serializer = new DefaultCookieSerializer();
    serializer.setUseSecureCookie(true);
    serializer.setUseHttpOnlyCookie(true);
    return serializer;
}
```

### Struts / JSP / Servlet
- Cookie生成時に明示的に属性を設定するコードが必要
