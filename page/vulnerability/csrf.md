---
title: CSRF(クロスサイト・リクエスト・フォージェリ)
next: false
---

# CSRF(クロスサイト・リクエスト・フォージェリ)

## 1. 概要・原因

**CSRF(Cross-Site Request Forgery)** は、ユーザーが意図しない操作をログイン済みのWebアプリケーションに対して実行させる攻撃です。

攻撃者は、以下のような仕組みで**信頼されたユーザーの権限を悪用**します：

- 被害者がログイン中の状態で攻撃者が用意したページを開く
- 攻撃者のページから、被害者がログインしているサイトへのリクエストが自動的に送信される(例：画像埋め込み、JS、フォーム自動送信)
- **Cookieなどの認証情報がブラウザにより自動送信されてしまう**

パスワードが変更されてしまう攻撃の例：
![パスワードが変更されてしまう攻撃の例](/images/csrf01.png)


## 2. 悪用事例・実際の事件

- **2012年:CSRFによる誤認逮捕事件** : [参考](https://atmarkit.itmedia.co.jp/ait/articles/1211/14/news012.html)
  - 2012年、遠隔操作ウイルス事件で複数の誤認逮捕が発生し、うち1件はCSRF脆弱性を悪用した掲示板書き込みだったと判明。
  - 横浜の大学生がCSRF経由で書き込みを行ったとされ、わずか2秒で300字の投稿が行われたことが物議を醸した。
  - 事件を機に、CSRFの危険性が一般にも広く知られる契機となった。



## 3. OWASP ASVS 5.0 における該当要件

| レベル   | 要件番号   | 内容                             |
| ----- | ------ | ------------------------------ |
| L1〜L3 | V3.4.3 | 重要な機能にはCSRFトークンなどの対策が実装されていること |
| L1〜L3 | V3.4.4 | CSRFトークンは一意で予測不可能であること         |


## 4. 一般的な対策

- **CSRFトークンの導入**

  - フォームや重要なAPI呼び出しには一意なトークンを付与し、サーバ側で検証する

- **SameSite Cookie属性の設定**

  - `SameSite=Lax` または `Strict` を指定することで、外部サイトからのリクエスト時にCookieが送信されなくなる(モダンブラウザはデフォルトLax)

- **Referer / Origin ヘッダ検査**

  - リクエストの出所が正当なオリジンか確認する

- **GETメソッドによる副作用のある操作を避ける**


## 5. フレームワーク別の注意点

### Spring Security

- `@EnableWebSecurity` + デフォルト設定でCSRF対策が有効
- フォームにCSRFトークンが自動で埋め込まれる
- REST API利用時にはCSRFを無効化 or トークンをヘッダに含める設計が必要
- CSRFトークン取得例：

  ```html
  <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
  ```

### Struts

- Struts2では `token` タグを使用したCSRF対策が可能

  ```jsp
  <s:token />
  ```
- 対策が組み込まれていない場合は手動でトークン検証が必要
